<?php
use Phalcon\Mvc\Micro;
use Phalcon\Validation;
use Phalcon\Validation\Validator\PresenceOf;
use Phalcon\Validation\Validator\Email;
use Aws\Credentials\CredentialProvider;
use Aws\Ses\SesClient;
use Aws\Ses\Exception\SesException;
require BASE_PATH.'/vendor/Crypto.php';
require BASE_PATH.'/vendor/mailin.php';
require BASE_PATH.'/vendor/class.phpmailer.php';

require BASE_PATH.'/vendor/autoload.php';

class LoginController extends \Phalcon\Mvc\Controller {
	CONST ldaprdn = 'cn=admin,dc=nidarachildren,dc=in';
	CONST ldappass = 'haselfre12';
	CONST host = 'localhost';

	// CONST host = 'apidev.nidarachildren.com';
	public function connection() {
		// using ldap bind
		// return self::host;
		$ldaprdn = 'cn=admin,dc=nidarachildren,dc=in'; // ldap rdn or dn
		$ldappass = 'haselfre12'; // associated password
		$binddn = "cn=admin,dc=nidarachildren,dc=in";
		// connect to ldap server
		$ldapconn = ldap_connect ( self::host ) or die ( "Could not connect to LDAP server." );
		ldap_set_option($ldapconn, LDAP_OPT_PROTOCOL_VERSION, 3);
	    return $ldapconn;
    }
		
	/**
	 * Fetch Record from database based on ID :-
	 */
	public function getbyid($id = null) {
		$input_data = $this->request->getJsonRawBody ();
		$id = isset ( $input_data->id ) ? $input_data->id : '';
		if (empty ( $id )) :
			return $this->response->setJsonContent ( [ 
					'status' => 'Error',
					'message' => 'Invalid input parameter' 
			] );
		 else :
			$collection = Subject::findFirstByid ( $id );
			if ($collection) :
				return Json_encode ( $collection );
			 else :
				return $this->response->setJsonContent ( [ 
						'status' => 'Error',
						'Message' => 'Data not found' 
				] );
			endif;
		endif;
	}
	public function getUnicId(){
		$code = $this -> generate_random_letters();
		return $this->response->setJsonContent([
			 'status' => true,
			'message' => $code		
		] );
	}

	function generate_random_letters() {
		$length = 3;
    		$random = '';
		$random .= 'NC';
    		for ($i = 0; $i < $length; $i++) {
        		$random .= chr(rand(ord('A'), ord('X')));
			$random .= chr(rand(ord(0), ord(9)));

    		}
    		return $random;
	}


	public function registerschooluser(){
		$input_data = $this->request->getJsonRawBody();
		if(empty($input_data)){
			return $this->response->setJsonContent([
			 	'status' => false,
				'message' => "Please give the details and then login"
			] );
		} else {
			$ldapconn = $this->connection ();
			foreach($input_data->parentInfo as $parentvalue){
				$user = new Users ();
				$user->id = $this->usersid->getNewId("users");
				$user->parent_type = 'father';
				$user->first_name = $parentvalue->first_name;
				$user->last_name = $parentvalue->last_name;
				$user->user_type = 'parent';
				$user->email = $parentvalue->email;
				$user->photo = 'https://s3.ap-south-1.amazonaws.com/illustration.nidarachildren.com/assets/kids/photo/icon.png';
				$user->mobile = $parentvalue->mobile;
				$user->created_at = date ( 'Y-m-d H:i:s' );
				$user->created_by = $input_data->id;
				$user->status = 2;
				$user->act_status = 2;
				$user->modified_at = date ( 'Y-m-d H:i:s' );
				if(!$user->save()){
					return $this->response->setJsonContent([
						'status' => false,
						'message' => "Parent not create"
					] );
				} else {
					$code = $this -> generate_random_letters();
					$email = $parentvalue->email;
					$password = $code;
					$userpassword = new UserTemPassword();
					$userpassword -> user_id = $user-> id;
					$userpassword -> password = $code;
					if(!$userpassword -> save()){
						return $this->response->setJsonContent ( [ 
							'status' => false,
							'message' => "Password not save"
						] );

					}
					$ldapbind = ldap_bind($ldapconn, self::ldaprdn, self::ldappass);
					if ($ldapbind) {
						/**
						 * This object using valitaion
						 */
						$ldaprecord ['sn'] [0] = $parentvalue-> first_name;
						$ldaprecord ['objectclass'] [2] = "top";
						$ldaprecord ['objectclass'] [1] = "posixAccount";
						$ldaprecord ['objectclass'] [0] = "inetOrgPerson";
						$ldaprecord ['uid'] [0] = $email;
						$ldaprecord ['gidnumber'] [0] = '500';
						$ldaprecord ['givenname'] [0] = $parentvalue-> first_name;
						$ldaprecord ['uidnumber'] [0] = $user-> id;
						$ldaprecord ['userpassword'] [0] = md5 ($password);
						$ldaprecord ['loginshell'] [0] = '/bin/sh';
						$ldaprecord ['homedirectory'] [0] = "/home/users/$email";
						$ldaprecord ['street'] [0] = $email;
						
						// add data to directory
						$r = ldap_add ( $ldapconn, 'cn=' . $email . ',ou=users,' . self::ldaprdn, $ldaprecord );
						
						if (!$r) {
							return $this->response->setJsonContent ( [ 
								'status' => false,
								'message' => 'couldnot save user' 
							] );
						}
					} else {
						return $this->response->setJsonContent ( [ 
								'status' => false,
								'message' => 'LDAP bind failed' 
						] );
					}
					foreach( $parentvalue->childInfo as $childvalue){
						$kidprofile = new NidaraKidProfile ();
						$kidprofile->id = $this->kididgen->getNewId ( "nidarakidprofile" );
						$kidprofile->first_name = $childvalue->first_name;
						if (! empty ( $childvalue->middle_name )) {
							$kidprofile->middle_name = $childvalue->middle_name;
						}
						$kidprofile->last_name = $childvalue->last_name;
						$kidprofile->date_of_birth = date('Y-m-d');
						if(!empty($input_data->age)){
							$kidprofile->age = $childvalue->age;
						}
						$kidprofile->gender = $childvalue->gender;
						$kidprofile->height = '0';
						$kidprofile->weight = '0';
						$kidprofile->grade = $childvalue->grade;
						$kidprofile->created_at = date ( 'Y-m-d H:i:s' );
						$kidprofile->created_by = $user -> id;
						$kidprofile->modified_at = date ( 'Y-m-d H:i:s' );
						$kidprofile->status = 2;
						$kidprofile->cancel_subscription = 1;
						if (empty ( $childvalue->child_photo )) {
							$gender = $childvalue->gender;
							if ($gender == 'male') {
								$kidprofile->child_photo = 'https://s3.amazonaws.com/nidara-dev/dev-files/no_image_male.png';
							} else {
								$kidprofile->child_photo = 'https://s3.amazonaws.com/nidara-dev/dev-files/no_image_female.png';
							}
						} 
						if (!$kidprofile->save ()) {
							return $this->response->setJsonContent([
								'status' => false,
								'message' => "Child not create",
								'data' => $kidprofile
							] );
						}
						else{
							$kid_guide = new KidGuidedLearningMap ();
							$kid_guide->id = $this->kididgen->getNewId ( "nidarakidlearningmap" );
							$kid_guide->nidara_kid_profile_id = $kidprofile->id;
							$kid_guide->guided_learning_id = $kidprofile->grade;
							$kid_guide->save ();
							$parentsmap = new KidParentsMap ();
							$parentsmap->id = $this->kididgen->getNewId ( "kidparentsmap" );
							$parentsmap->nidara_kid_profile_id = $kidprofile->id;
							$parentsmap->users_id = $user -> id;
							$parentsmap->save();
						}
					}
					$parentmap = new SchoolParentMap();
					$parentmap -> school_id = $input_data -> id;
					$parentmap -> user_id = $user -> id;
					if(!$parentmap -> save()){
						return $this->response->setJsonContent([
							'status' => false,
							'message' => "Map is not create"
						] );
					}
				}
			}
			return $this->response->setJsonContent([
				'status' => true,
				'message' => "Data Save successfuly"
			] );
		}
	}


	// public function childregister($input_data){

	// }
	
	/**
	 * This function using to register the user
	 */
	public function register() {
		$input_data = $this->request->getJsonRawBody();
		if(empty($input_data)){
			return $this->response->setJsonContent([
					'status' => false,
					'message' => "Please give the details and then login"
			] );
		}
		$validation = new Validation ();
		$validation->add ( 'first_name', new PresenceOf ( [ 
				'message' => 'First name is required' 
		] ) );
		$validation->add ( 'last_name', new PresenceOf ( [ 
				'message' => 'Last name is required' 
		] ) );
		$validation->add ( 'email', new PresenceOf ( [
				'message' => 'Email is required'
		] ) );
		$validation->add ( 'email', new Email ( [
				'message' => 'Please give the valid email'
		] ) );
		$validation->add ( 'password', new PresenceOf ( [ 
				'message' => 'Password is required' 
		] ) );
		$validation->add ( 'confirmpassword', new PresenceOf ( [
				'message' => 'Confirm Password is required'
		] ) );
		$validation->add ( 'parent_type', new PresenceOf ( [
				'message' => 'Parent Type is required'
		] ) );
		$messages = $validation->validate ( $input_data );
		if (count ( $messages )) {
			
			foreach ( $messages as $message ) {
				$result [] = $message->getMessage ();
			}
			return $this->response->setJsonContent([ 
					'status' => false,
					'message' => $result
			] );
		}
		if ($input_data->password != $input_data->confirmpassword) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => "Password does not match" 
			] );
		}
		$ldapconn = $this->connection ();
		
		$email = $input_data->email;
		$userexist=Users::findFirstByemail($email);
		if(!empty($userexist)){
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => "This email address is already in use. Please enter a different one."
			] );
		}
		$user_id = $this->usercreate ( $input_data );
		$ldapbind = ldap_bind($ldapconn, self::ldaprdn, self::ldappass);
		if ($ldapbind) {
			/**
			 * This object using valitaion
			 */
			$ldaprecord ['sn'] [0] = $input_data->first_name;
			$ldaprecord ['objectclass'] [2] = "top";
			$ldaprecord ['objectclass'] [1] = "posixAccount";
			$ldaprecord ['objectclass'] [0] = "inetOrgPerson";
			$ldaprecord ['uid'] [0] = $email;
			$ldaprecord ['gidnumber'] [0] = '500';
			$ldaprecord ['givenname'] [0] = $input_data->first_name;
			$ldaprecord ['uidnumber'] [0] = $user_id;
			$ldaprecord ['userpassword'] [0] = md5 ( $input_data->password );
			$ldaprecord ['loginshell'] [0] = '/bin/sh';
			$ldaprecord ['homedirectory'] [0] = "/home/users/$email";
			$ldaprecord ['street'] [0] = $email;
			
			// add data to directory
			$r = ldap_add ( $ldapconn, 'cn=' . $email . ',ou=users,' . self::ldaprdn, $ldaprecord );
			
			if ($r) {
				$this->wp_users_create($input_data);
				
				$user_info = Users::findFirstByemail($email);
				if($user_info->status !== '1'){
				
				$working_key = '21F05B7B25BA3BEF8A7D7507C1DBD21F';
				$emailencrypted = encrypt($user_info->email,$working_key);
				
				$emailstatus = new EmailVerify();
				//$emailstatus->id = $this->usersid->getNewId("users");
				$emailstatus->encrypt_code = $emailencrypted;
				$emailstatus->email_id = $user_info->email;
				$emailstatus->status = 0;
				$emailstatus->created_date = date ( 'Y-m-d H:i:s' );
				$emailstatus->save();
				if($user_info->status === '3'){
					$emailcontent = '<div class="sub-mail-cont">
												<span>Hi <span class="first-name">'. $user_info->first_name .' '. $user_info->last_name .'</span>, </span>
												<p>We just need to verify your email address before you can start using Nidara-Children.</p>
											</div>
											<br>
											 <div class="sub-mail-but">
											 <p>
											   <a class="sub-but" style="text-decoration: none; color: #333; padding: 10px 50px; border: 1px solid;" href="'. $this->config->weburl .'/emailverify/'. $emailencrypted .'"><b>VERIFY YOUR EMAIL</b>
											  </a>
											  </p>
											 </div>';
				}
				else if($user_info->status === '2'){
					$emailcontent = '<div class="sub-mail-cont">
												<span>Hi <span class="first-name">'. $user_info->first_name .' '. $user_info->last_name .'</span>, </span>
												<p>We just need to verify your email address before you can start using Nidara-Children Free Trial for 7 Days.</p>
											</div>
											<br>
											 <div class="sub-mail-but">
											 <p>
											   <a class="sub-but" style="text-decoration: none; color: #333; padding: 10px 50px; border: 1px solid;" href="'. $this->config->weburl .'/emailverify/'. $emailencrypted .'"><b>VERIFY YOUR EMAIL</b>
											  </a>
											  </p>
											 </div>';
				}
					
					$mail = new PHPMailer;

					//$mail->SMTPDebug = 3;                               // Enable verbose debug output

					$mail->isSMTP();                                      // Set mailer to use SMTP
					$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
					$mail->SMTPAuth = true;                               // Enable SMTP authentication
					$mail->Username = 'baskar@haselfre.com';                 // SMTP username
					$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
					$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
					$mail->Port = 587;                                    // TCP port to connect to

					$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
					$mail->addAddress($user_info->email, '');     // Add a recipient
																			// Name is optional
					$mail->addReplyTo('contact@haselfre.com', 'Information');

					//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
					//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
					$mail->isHTML(true);                                  // Set email format to HTML

					$mail->Subject = 'Welcome to Nidara Children';
					$mail->Body    = '
					<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

           body,td{
            font-family:verdana,geneva;
            font-size:12px;
           }
           body{
            background:#fff;
            padding:20px;
           }
           .top-img{
            width:100%;
            text-align:center;
            padding-bottom:0;
            font-size:10px;
           }
           .sub-mail-cont{
            width:100%;
           }
           .sub-mail-vr{
            width:580px;
            margin:auto;
            float:none;
           }
           .main-page-mail{
            width:100%;
            float:left;
            padding:20px;
            border:1px solid #999;
           }
           .sub-mail-but{
            width:100%;
            text-align:center;
            padding-top:30px;
            float:left;
           }
           a.sub-but{
            text-decoration:none;
            color:#333;
            padding:10px 50px;
            border:1px solid;
           }
           .sub-but-cont{
            width:100%;
            padding-top:20px;
            float:left;
           }
           .footer{
            width:100%;
            text-align:center;
            font-size:10px;
            padding-top:20px;
            float:left;
           }
           .footer ul{
            list-style:none;
            float:left;
            margin:15px 10px;
            width:100%;
            padding:0;
           }
           .footer ul li{
            display:inline-flex;
            padding-left:5px;
           }
           p{
            line-height:18px;
           }
           .small{
            font-size:11px;
           }
           .main-title{
            text-align:center;
            color:#aed7d3;
            float:left;
            width:100%;
           }
           .main-title h3{
            font-weight:500;
           }
           .first-name{
            text-transform:capitalize;
           }
           .product-img{
            width:20%;
            float:left;
            padding-right:20px;
           }
           .product-img img{
            width:100%;
           }
           .product-cont{
            width:75%;
            float:left;
           }
           .product-details{
            width:100%;
            float:left;
           }
         
span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

          
          <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
            <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
           <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
             <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
           </div>
           '. $emailcontent .'
            
            <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
           <p style="line-height: 18px;">Best regards,</p>
           <p style="line-height: 18px;">
            </p>
            <p style="line-height: 18px;">Nidara Children</p>
          </div>
          <div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
            <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
             <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
           </li>
           </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
           <br /><span>You are receiving this email because you opted in at our website.
            </span>
            
            <br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
          </div>
           </div>
         </div>
         
</td></tr></table>
</body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

           body,td{
            font-family:verdana,geneva;
            font-size:12px;
           }
           body{
            background:#fff;
            padding:20px;
           }
           .top-img{
            width:100%;
            text-align:center;
            padding-bottom:0;
            font-size:10px;
           }
           .sub-mail-cont{
            width:100%;
           }
           .sub-mail-vr{
            width:580px;
            margin:auto;
            float:none;
           }
           .main-page-mail{
            width:100%;
            float:left;
            padding:20px;
            border:1px solid #999;
           }
           .sub-mail-but{
            width:100%;
            text-align:center;
            padding-top:30px;
            float:left;
           }
           a.sub-but{
            text-decoration:none;
            color:#333;
            padding:10px 50px;
            border:1px solid;
           }
           .sub-but-cont{
            width:100%;
            padding-top:20px;
            float:left;
           }
           .footer{
            width:100%;
            text-align:center;
            font-size:10px;
            padding-top:20px;
            float:left;
           }
           .footer ul{
            list-style:none;
            float:left;
            margin:15px 10px;
            width:100%;
            padding:0;
           }
           .footer ul li{
            display:inline-flex;
            padding-left:5px;
           }
           p{
            line-height:18px;
           }
           .small{
            font-size:11px;
           }
           .main-title{
            text-align:center;
            color:#aed7d3;
            float:left;
            width:100%;
           }
           .main-title h3{
            font-weight:500;
           }
           .first-name{
            text-transform:capitalize;
           }
           .product-img{
            width:20%;
            float:left;
            padding-right:20px;
           }
           .product-img img{
            width:100%;
           }
           .product-cont{
            width:75%;
            float:left;
           }
           .product-details{
            width:100%;
            float:left;
           }
         
span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

          
          <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
            <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
           <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
             <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
           </div>
           '. $emailcontent .'
            
            <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
           <p style="line-height: 18px;">Best regards,</p>
           <p style="line-height: 18px;">
            </p>
            <p style="line-height: 18px;">Nidara Children</p>
          </div>
          <div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
            <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
             <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
           </li>
           </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
           <br /><span>You are receiving this email because you opted in at our website.
            </span>
            
            <br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
          </div>
           </div>
         </div>
         
</td></tr></table>
</body>
</html>

					';
					$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

					if(!$mail->send()) {
						return $this->response->setJsonContent ( [ 
								'status' => false,
								'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
						] );
						
					} else {
					
						
					} 
				}
				return $this->response->setJsonContent ( [ 
						'status' => true,
						'message' => 'User registered successfully',
						'user_info' => $user_info
				] );
			} else {
				return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'couldnot save user' 
				] );
			}
		} 
		else {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'LDAP bind failed' 
			] );
		}
	}

	/**
	 * Users create in wp site
	 */
	function wp_users_create($input_data){
		$parameters = array (
				'first_name' => $input_data->first_name,
				'last_name' => $input_data->last_name,
				'email' => $input_data->email,
				'password' => md5 ( $input_data->password ),
				'api_key' => $this->config->wpapi_key
		);
		$inputparams = json_encode ( $parameters );
		$ch = curl_init ();
		curl_setopt ( $ch, CURLOPT_URL, $this->config->wpurl.'data-account.php');
	    curl_setopt($ch, CURLOPT_HTTPHEADER, [
              'Content-Type: application/json',                    
              'Content-Length: ' . strlen($inputparams)
               ]
        );		
        curl_setopt ( $ch, CURLOPT_RETURNTRANSFER, 1 );
		curl_setopt ( $ch, CURLOPT_POSTFIELDS,$inputparams );
		$contents = curl_exec ( $ch );
		curl_close ( $ch );
	}

	/**
	 * Create user
	 * @param object $input_data
	 */
	function usercreate($input_data) {
		$user = new Users ();
		$user->id = $this->usersid->getNewId("users");
		$user->parent_type = $input_data->parent_type;
		$user->first_name = $input_data->first_name;
		$user->last_name = $input_data->last_name;
		if($input_data->parent_type == 'doctor'){
			$user->user_type = 'doctor';
		}
		else{
			$user->user_type = 'parent';
		}
		$user->email = $input_data->email;
		$user->photo = 'https://s3.ap-south-1.amazonaws.com/illustration.nidarachildren.com/assets/kids/photo/icon.png';
		$user->mobile = $input_data->mobile;
		$user->created_at = date ( 'Y-m-d H:i:s' );
		$user->created_by = $user->id;
		$user->status = $input_data->status;
		$user->act_status = $input_data->act_status;
		$user->modified_at = date ( 'Y-m-d H:i:s' );
		$user->save();
		if($input_data->parent_type == 'doctor'){
			$doctor_code = new DoctorCode();
			$doctor_code->user_id = $user->id;
			$doctor_code->doctor_code = 'NIDARA-DOCTOR-'.$user->id;
			$doctor_code-> save();
			
			$qualification = new DoctorInfo();
			$qualification -> register_no = $input_data->registration_number;
			$qualification -> qualification = $input_data->qualification;
			$qualification -> user_id = $user->id;
			$qualification -> save();
		}
		$parents_map = new ParentsMappingProfiles ();
		$parents_map->id = $this->parentsidgen->getNewId("parentsmap");
		$parents_map->primary_parents_id = $user->id;
		$parents_map->primary_parent_type = $input_data->parent_type;
		$parents_map->save ();
		$collection = new UsersAddress ();
		$collection->id = $this->parentsidgen->getNewId ( "address" );
		$collection-> user_id = $user->id;
		$collection->address_1 = $input_data->address_1;
		$collection->address_2 = $input_data->address_2;
		$collection->city = $input_data->city;
		$collection->state = $input_data->state;
		$collection->country = $input_data->country;
		$collection->post_code = $input_data->postcode;
		$collection->created_at = date ( 'Y-m-d H:i:s' );
		$collection->created_by = $user->id;
		$collection->modified_at = date ( 'Y-m-d H:i:s' );
		$collection->save();
		$doctor_map = new DoctorParentMap();
		$doctor_map ->id = $this->parentsidgen->getNewId ( "doctor-map" );
		$doctor_map ->user_id = $user->id;
		$doctor_map ->doctor_code = $input_data->offer_code;
		$doctor_map ->created_at = date ( 'Y-m-d H:i:s' );
		$doctor_map ->save();	
			
		return $user->id;
	}
	
	public function uaseraddress(){
		$input_data = $this->request->getJsonRawBody();
		if(empty($input_data)){
			return $this->response->setJsonContent([
					'status' => false,
					'message' => "Please give the details and then login"
			] );
		}	
	}
	
	/**
	 * This function using to Subject information edit
	 */
	public function forgotpassword() {
		$ldapconn = $this->connection ();
		$input_data = $this->request->getJsonRawBody ();
		if(empty($input_data->username)){
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Please give the username' 
			] );
		}
		// Forget password
		$email = array (
				"street" 
		);
		// Search surname entry
		$user = ldap_search ( $ldapconn, self::ldaprdn, "uid=stest", $email );
		$ses = $this->sesConfiguration ();
		$userinfo = ldap_get_entries ( $ldapconn, $user );
		$authentication = new AuthenticationController ();
		$token = ( string ) $authentication->tokengenerate ( $userinfo [0] ['uidnumber'] [0],$input_data->username );
		
		// $baseurl = ''. $this->config->weburl .'/';
		$changeurl = $this->config->weburl . '/resetpassword/?token=' . $token;
		$user_info = Users::findFirstByemail($input_data->username);
		$mail = new PHPMailer;

		//$mail->SMTPDebug = 3;                               // Enable verbose debug output

		$mail->isSMTP();                                      // Set mailer to use SMTP
		$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
		$mail->SMTPAuth = true;                               // Enable SMTP authentication
		$mail->Username = 'contact@haselfre.com';                 // SMTP username
		$mail->Password = '';                           // SMTP password
		$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
		$mail->Port = 587;                                    // TCP port to connect to

		$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
		$mail->addAddress($input_data->username, '');     // Add a recipient
																// Name is optional
		$mail->addReplyTo('contact@haselfre.com', 'Information');

		//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
		//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
		$mail->isHTML(true);                                  // Set email format to HTML

		$mail->Subject = 'RESET YOUR NIDARA-CHILDREN PASSWORD…';
		$mail->Body    = '
						<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

  body,td{
   font-family:verdana,geneva;
   font-size:12px;
  }
  body{
   background:#fff;
   padding:20px;
  }
  .top-img{
   width:100%;
   text-align:center;
   padding-bottom:0;
   font-size:10px;
  }
  .sub-mail-cont{
   width:100%;
  }
  .sub-mail-vr{
   width:580px;
   margin:auto;
   float:none;
  }
  .main-page-mail{
   width:100%;
   float:left;
   padding:20px;
   border:1px solid #999;
  }
  .sub-mail-but{
   width:100%;
   text-align:center;
   padding-top:30px;
   float:left;
  }
  a.sub-but{
   text-decoration:none;
   color:#fff;
   padding:10px 50px;
   background:#AFD2DB;
  }
  .sub-but-cont{
   width:100%;
   padding-top:20px;
   float:left;
  }
  .footer{
   width:100%;
   text-align:center;
   font-size:10px;
   padding-top:20px;
   float:left;
  }
  .footer ul{
   list-style:none;
   float:left;
   margin:15px 10px;
   width:100%;
   padding:0;
  }
  .footer ul li{
   display:inline-flex;
   padding-left:5px;
  }
  p{
   line-height:18px;
  }
  .small{
   font-size:11px;
  }
  .main-title{
   text-align:center;
   color:#aed7d3;
   float:left;
   width:100%;
  }
  .main-title h3{
   font-weight:500;
  }
  .first-name{
   text-transform:capitalize;
  }
  .product-img{
   width:20%;
   float:left;
   padding-right:20px;
  }
  .product-img img{
   width:100%;
  }
  .product-cont{
   width:75%;
   float:left;
  }
  .product-details{
   width:100%;
   float:left;
  }
  .sub-mail-cont{
   width:100%;
   float:left;
  }

span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

    
    <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
      <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
        <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
          <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
        </div>
        <div class="main-title" style="text-align: center; color: #aed7d3; float: left; width: 100%;">
          <h3 style="font-weight: 500;">RESET YOUR NIDARA-CHILDREN PASSWORD&hellip;</h3>
        </div>
        <div class="sub-mail-cont" style="width: 100%; float: left;">
          <span>Hi <span class="first-name" style="text-transform: capitalize;">'. $user_info->first_name .' '. $user_info->last_name .'</span>, </span>
          <br /><p style="line-height: 18px;">Someone recently requested a password change for your Nidara Children account. If this was you, you can set a new password here:
        </p>
      </div>
      <div class="sub-mail-but" style="width: 100%; text-align: center; padding-top: 30px; float: left;">
        <p style="line-height: 18px;">
        <a class="sub-but" href="'. $changeurl .'" style="text-decoration: none; color: #fff; padding: 10px 50px; background: #AFD2DB;"><b>RESET PASSWORD
          </b></a>
        </p>
      </div>
      
      <div class="sub-mail-cont" style="width: 100%; float: left;">
        
        <br /><p style="line-height: 18px;">If you don`t want to change your password or didn`t request this, just ignore and delete this message.
      </p>
      <p style="line-height: 18px;">
      To keep your account secure, please don`t forward this email to anyone
    </p>
  </div>
  
  <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
    <p style="line-height: 18px;">Best regards,</p>
    <p style="line-height: 18px;">
  </p>
  <p style="line-height: 18px;">Nidara Children</p>
</div>
<div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
  <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
      <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
    </li>
    <li style="display: inline-flex; padding-left: 5px;">
      <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
    </li>
    <li style="display: inline-flex; padding-left: 5px;">
      <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
    </li>
    <li style="display: inline-flex; padding-left: 5px;">
      <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
    </li>
    </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
    <br /><span>You are receiving this email because you opted in at our website.
  </span>
  
  <br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
</div>
</div>
</div>

</td></tr></table>
</body>
</html>

		';
		$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

		if(!$mail->send()) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
			] );
			
		} else {
		
			return $this->response->setJsonContent ( [ 
					'status' => true,
					'message' => 'Please check your email for password reset instructions.' 
			] );
		}
		
	}
	
	
	public function tokenSend(){
		$input_data = $this->request->getJsonRawBody ();
		$mail = new PHPMailer;

		//$mail->SMTPDebug = 3;                               // Enable verbose debug output

		$mail->isSMTP();                                      // Set mailer to use SMTP
		$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
		$mail->SMTPAuth = true;                               // Enable SMTP authentication
		$mail->Username = 'baskar@haselfre.com';                 // SMTP username
		$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
		$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
		$mail->Port = 587;                                    // TCP port to connect to

		$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
		$mail->addAddress($input_data->email, '');     // Add a recipient
																// Name is optional
		$mail->addReplyTo('contact@haselfre.com', 'Information');

		//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
		//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
		$mail->isHTML(true);                                  // Set email format to HTML

		$mail->Subject = 'Free Trial Activation';
		$mail->Body    = '
						<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

         body,td{
          font-family:verdana,geneva;
          font-size:12px;
         }
         body{
          background:#fff;
          padding:20px;
         }
         .top-img{
          width:100%;
          text-align:center;
          padding-bottom:0;
          font-size:10px;
         }
         .sub-mail-cont{
          width:100%;
         }
         .sub-mail-vr{
          width:580px;
          margin:auto;
          float:none;
         }
         .main-page-mail{
          width:100%;
          float:left;
          padding:20px;
          border:1px solid #999;
         }
         .sub-mail-but{
          width:100%;
          text-align:center;
          padding-top:30px;
          float:left;
         }
         a.sub-but{
          text-decoration:none;
          color:#333;
          padding:10px 50px;
          border:1px solid;
         }
         .sub-but-cont{
          width:100%;
          padding-top:20px;
          float:left;
         }
         .footer{
          width:100%;
          text-align:center;
          font-size:10px;
          padding-top:20px;
          float:left;
         }
         .footer ul{
          list-style:none;
          float:left;
          margin:15px 10px;
          width:100%;
          padding:0;
         }
         .footer ul li{
          display:inline-flex;
          padding-left:5px;
         }
         p{
          line-height:18px;
         }
         .small{
          font-size:11px;
         }
         .main-title{
          text-align:center;
          color:#aed7d3;
          float:left;
          width:100%;
         }
         .main-title h3{
          font-weight:500;
         }
         .first-name{
          text-transform:capitalize;
         }
         .product-img{
          width:20%;
          float:left;
          padding-right:20px;
         }
         .product-img img{
          width:100%;
         }
         .product-cont{
          width:75%;
          float:left;
         }
         .product-details{
          width:100%;
          float:left;
         }
       
span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

        
        <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
          <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
         <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
           <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
         </div>
         <div class="main-title" style="text-align: center; color: #aed7d3; float: left; width: 100%;">
           <h3 style="font-weight: 500;">WELCOME TO NIDARA-CHILDREN</h3>
         </div>
         <div class="sub-mail-cont" style="width: 100%;">
          <span>Hi <span class="first-name" style="text-transform: capitalize;">'. $input_data->user_first_name .' '. $input_data->user_last_name .'</span>, </span>
          <br /><p style="line-height: 18px;">Welcome to Nidara-Children, a pioneering early child development system dedicated to providing children the best start in life.
          </p>
          <p style="line-height: 18px;">Hope you find our premium system helpful in raising your child.</p>
         </div>
          <div class="sub-mail-but" style="width: 100%; text-align: center; padding-top: 30px; float: left;">
          <p style="line-height: 18px;">
          <a class="sub-but" href="'. $this->config->weburl .'/child-profileid-register?token='. $input_data->token .'" style="text-decoration: none; color: #333; padding: 10px 50px; border: 1px solid;"><b>ACTIVATE FREE TRIAL</b></a>
           </p>
         </div>
          <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
         <p style="line-height: 18px;">Best regards,</p>
         <p style="line-height: 18px;">
          </p>
          <p style="line-height: 18px;">Nidara Children</p>
        </div>
        <div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
          <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
           <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
         </li>
         <li style="display: inline-flex; padding-left: 5px;">
           <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
         </li>
         <li style="display: inline-flex; padding-left: 5px;">
           <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
         </li>
         <li style="display: inline-flex; padding-left: 5px;">
           <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
         </li>
         </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
         <br /><span>You are receiving this email because you opted in at our website.
          </span>
          
          <br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
        </div>
         </div>
       </div>
       
</td></tr></table>
</body>
</html>

		';
		$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

		if(!$mail->send()) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
			] );
			
		} else {
		
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Message has been sent' 
			] );
		}
	}
	
	
		public function productmailsend(){
		$input_data = $this->request->getJsonRawBody ();
		$mail = new PHPMailer;

		//$mail->SMTPDebug = 3;                               // Enable verbose debug output

		$mail->isSMTP();                                      // Set mailer to use SMTP
		$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
		$mail->SMTPAuth = true;                               // Enable SMTP authentication
		$mail->Username = 'baskar@haselfre.com';                 // SMTP username
		$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
		$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
		$mail->Port = 587;                                    // TCP port to connect to

		$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
		$mail->addAddress($input_data->email, '');     // Add a recipient
																// Name is optional
		$mail->addReplyTo('contact@haselfre.com', 'Information');

		$mail->isHTML(true);                                  // Set email format to HTML
		
		$mail->Subject = 'THANK YOU FOR YOUR PURCHASE AT NIDARA-CHILDREN…';
		$ncproduct = $this->modelsManager->createBuilder ()->columns ( array (
					'NCProductPricing.id as ids',
					'NCProductPricing.product_type as product_type',
					'NCProduct.product_name as product_name',
					'NCProduct.product_img as product_img',
					'NCProductPricing.product_price as product_price',
					'SUM (NCProductPricing.product_price) as subtotal',
					'COUNT (NCOrderProductList.product_id) as item',
					'COUNT (NCOrderProductList.product_id) as qty',
				))->from("NCOrderList")
				->leftjoin('NCOrderProductList','NCOrderProductList.order_id = NCOrderList.id')
				->leftjoin('NCOrderStatus','NCOrderStatus.order_id = NCOrderList.id')
				->leftjoin('NCProductPricing','NCOrderProductList.product_id = NCProductPricing.id')
				->leftjoin('NCProduct','NCProductPricing.product_id = NCProduct.id')
				->inwhere("NCOrderList.user_id",array($input_data->user_id))
				->inwhere("NCOrderList.order_id",array($input_data->order_id))
				->groupBy("NCOrderProductList.product_id")
				->getQuery ()->execute ();
				$product = '';
				foreach($ncproduct as $value){
					$product .= '<div class="product-details">';
					$product .= '<div class="product-img">';
					$product .= '<img src="';
					$product .= $value->product_img;
					$product .= '">';
					$product .= '</div>';
					$product .= '<div class="product-cont">';
					$product .= '<h4>';
					$product .= $value->product_name;
					$product .= '</h4>';
					$product .= '<p>Rs. ';
					$product .= $value->product_price;
					$product .= ' / month for 12 months</p>';
					$product .= '<p><span>Billing Cycle: Billed </span> <span style="float:right;padding-right:20px">Total:  Rs.';
					$product .= $value->product_price;
					$product .= '</span></p>';
					$product .= '</div>';
				}
				$product .= '';
				
		$mail->Body    = '
						<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
			<html>
			<head>
			<meta http-equiv="content-type" content="text/html; charset=utf-8" />
			<style type="text/css">
			.ReadMsgBody {width: 100%;}
			.ExternalClass {width: 100%;}

			body {}

			  body,td{
			   font-family:verdana,geneva;
			   font-size:12px;
			  }
			  body{
			   background:#fff;
			   padding:20px;
			  }
			  .top-img{
			   width:100%;
			   text-align:center;
			   padding-bottom:0;
			   font-size:10px;
			  }
			  .sub-mail-cont{
			   width:100%;
			  }
			  .sub-mail-vr{
			   width:580px;
			   margin:auto;
			   float:none;
			  }
			  .main-page-mail{
			   width:100%;
			   float:left;
			   padding:20px;
			   border:1px solid #999;
			  }
			  .sub-mail-but{
			   width:100%;
			   text-align:center;
			   padding-top:30px;
			   float:left;
			  }
			  a.sub-but{
			   text-decoration:none;
			   color:#333;
			   padding:10px 50px;
			   border:1px solid;
			  }
			  .sub-but-cont{
			   width:100%;
			   padding-top:20px;
			   float:left;
			  }
			  .footer{
			   width:100%;
			   text-align:center;
			   font-size:10px;
			   padding-top:20px;
			   float:left;
			  }
			  .footer ul{
			   list-style:none;
			   float:left;
			   margin:15px 10px;
			   width:100%;
			   padding:0;
			  }
			  .footer ul li{
			   display:inline-flex;
			   padding-left:5px;
			  }
			  p{
			   line-height:18px;
			  }
			  .small{
			   font-size:11px;
			  }
			  .main-title{
			   text-align:center;
			   color:#aed7d3;
			   float:left;
			   width:100%;
			  }
			  .main-title h3{
			   font-weight:500;
			  }
			  .first-name{
			   text-transform:capitalize;
			  }
			  .product-img{
			   width:20%;
			   float:left;
			   padding-right:20px;
			  }
			  .product-img img{
			   width:100%;
			  }
			  .product-cont{
			   width:75%;
			   float:left;
			  }
			  .product-details{
			   width:100%;
			   float:left;
			  }

			span.yshortcuts { color:#000; background-color:none; border:none;}
			span.yshortcuts:hover,
			span.yshortcuts:active,
			span.yshortcuts:focus {color:#000; background-color:none; border:none;}
			</style>
			</head>
			<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

				
				<div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
				  <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
					<div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
					  <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
					</div>
					<div class="main-title" style="text-align: center; color: #aed7d3; float: left; width: 100%;">
					  <h3 style="font-weight: 500;">THANK YOU FOR YOUR PURCHASE AT NIDARA-CHILDREN&hellip;
					  </h3>
					</div>
					<div class="sub-mail-cont" style="width: 100%;">
					  <span>Hi <span class="first-name" style="text-transform: capitalize;">'. $input_data->user_first_name .' '. $input_data->user_last_name .'</span>, </span>
					  <br /><p style="line-height: 18px;">Thank you for purchasing the premium Nidara-Children Early Child Development System for your little child.  A copy of your purchase is below for your records
					</p>
					'. $product  .'
				   
				  </div>
				
				<div class="sub-mail-but" style="width: 100%; text-align: center; padding-top: 30px; float: left;">
				  <p style="line-height: 18px;">
				  <a class="sub-but" href="'. $this->config->weburl .'/child-profileid-register?token='. $input_data->token .'" style="text-decoration: none; color: #333; padding: 10px 50px; border: 1px solid;"><b>START USING NIDARA-CHILDREN
				  </b>
				</a>
			  </p>
			</div>
			<div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
			  <p style="line-height: 18px;">Best regards,</p>
			  <p style="line-height: 18px;">
			</p>
			<p style="line-height: 18px;">Nidara Children</p>
			</div>
			<div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
			<ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
			<li style="display: inline-flex; padding-left: 5px;">
				<a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
			  </li>
			  <li style="display: inline-flex; padding-left: 5px;">
				<a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
			  </li>
			  <li style="display: inline-flex; padding-left: 5px;">
				<a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
			  </li>
			  <li style="display: inline-flex; padding-left: 5px;">
				<a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
			  </li>
			  </ul>
			<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
			  <br /><span>You are receiving this email because you opted in at our website.
			</span>
			<br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
			</div>
			</div>
			</div>


			</td></tr></table>
			</body>
			</html>
		';
		$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

		if(!$mail->send()) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
			] );
			
		} else {
		
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Message has been sent' 
			] );
		}
	}
	
	
	
	
	public function posttokenSend(){
		$input_data = $this->request->getJsonRawBody ();
		$mail = new PHPMailer;

		//$mail->SMTPDebug = 3;                               // Enable verbose debug output

		$mail->isSMTP();                                      // Set mailer to use SMTP
		$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
		$mail->SMTPAuth = true;                               // Enable SMTP authentication
		$mail->Username = 'baskar@haselfre.com';                 // SMTP username
		$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
		$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
		$mail->Port = 587;                                    // TCP port to connect to

		$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
		$mail->addAddress($input_data->email, '');     // Add a recipient
																// Name is optional
		$mail->addReplyTo('contact@haselfre.com', 'Information');

		//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
		//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
		$mail->isHTML(true);                                  // Set email format to HTML

		$mail->Subject = 'THANK YOU FOR YOUR PURCHASE AT NIDARA-CHILDREN…';
		$mail->Body    = '
						<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

         body,td{
          font-family:verdana,geneva;
          font-size:12px;
         }
         body{
          background:#fff;
          padding:20px;
         }
         .top-img{
          width:100%;
          text-align:center;
          padding-bottom:0;
          font-size:10px;
         }
         .sub-mail-cont{
          width:100%;
         }
         .sub-mail-vr{
          width:580px;
          margin:auto;
          float:none;
         }
         .main-page-mail{
          width:100%;
          float:left;
          padding:20px;
          border:1px solid #999;
         }
         .sub-mail-but{
          width:100%;
          text-align:center;
          padding-top:30px;
          float:left;
         }
         a.sub-but{
          text-decoration:none;
          color:#333;
          padding:10px 50px;
          border:1px solid;
         }
         .sub-but-cont{
          width:100%;
          padding-top:20px;
          float:left;
         }
         .footer{
          width:100%;
          text-align:center;
          font-size:10px;
          padding-top:20px;
          float:left;
         }
         .footer ul{
          list-style:none;
          float:left;
          margin:15px 10px;
          width:100%;
          padding:0;
         }
         .footer ul li{
          display:inline-flex;
          padding-left:5px;
         }
         p{
          line-height:18px;
         }
         .small{
          font-size:11px;
         }
         .main-title{
          text-align:center;
          color:#aed7d3;
          float:left;
          width:100%;
         }
         .main-title h3{
          font-weight:500;
         }
         .first-name{
          text-transform:capitalize;
         }
         .product-img{
          width:20%;
          float:left;
          padding-right:20px;
         }
         .product-img img{
          width:100%;
         }
         .product-cont{
          width:75%;
          float:left;
         }
         .product-details{
          width:100%;
          float:left;
         }
       
span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

        
        <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
          <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
         <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
           <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
         </div>
         <div class="main-title" style="text-align: center; color: #aed7d3; float: left; width: 100%;">
           <h3 style="font-weight: 500;">WELCOME TO NIDARA-CHILDREN</h3>
         </div>
         <div class="sub-mail-cont" style="width: 100%;">
          <span>Hi <span class="first-name" style="text-transform: capitalize;">'. $input_data->user_first_name .' '. $input_data->user_last_name .'</span>, </span>
          <br /><p style="line-height: 18px;">Welcome to Nidara-Children, a pioneering early child development system dedicated to providing children the best start in life.
          </p>
          <p style="line-height: 18px;">Hope you find our premium system helpful in raising your child.</p>
         </div>
          <div class="sub-mail-but" style="width: 100%; text-align: center; padding-top: 30px; float: left;">
          <p style="line-height: 18px;">
          <a class="sub-but" href="'. $this->config->weburl .'/child-profileid-register?token='. $input_data->token .'" style="text-decoration: none; color: #333; padding: 10px 50px; border: 1px solid;"><b>START USING NIDARA-CHILDREN</b></a>
           </p>
         </div>
          <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
         <p style="line-height: 18px;">Best regards,</p>
         <p style="line-height: 18px;">
          </p>
          <p style="line-height: 18px;">Nidara Children</p>
        </div>
        <div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
          <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
           <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
         </li>
         <li style="display: inline-flex; padding-left: 5px;">
           <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
         </li>
         <li style="display: inline-flex; padding-left: 5px;">
           <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
         </li>
         <li style="display: inline-flex; padding-left: 5px;">
           <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
         </li>
         </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
         <br /><span>You are receiving this email because you opted in at our website.
          </span>
          
          <br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
         </div>        </div>

       </div>
       
</td></tr></table>
</body>
</html>

		';
		$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

		if(!$mail->send()) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
			] );
			
		} else {
		
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Message has been sent' 
			] );
		}
	}
	
	
	public function successtokensend(){
		$input_data = $this->request->getJsonRawBody ();
		$order_id = isset ($input_data->order_id) ? $input_data->order_id : '';
		$collection = $this->modelsManager->createBuilder ()->columns ( array (
			'NCOrderList.user_id as user_id',
			'NCOrderList.order_id as order_ids',
		))->from("NCOrderList")
		->leftjoin('NCOrderStatus','NCOrderStatus.order_id = NCOrderList.id')
		->inwhere("NCOrderList.order_id",array($order_id))
		->inwhere("NCOrderStatus.status",array('Success'))
		->getQuery ()->execute ();
		if(count($collection) === 0){
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid User main' 
			] );
		}
		else{
			foreach($collection as $valid){
				
			}
			$userval = Users::findFirstByid($valid->user_id);
			return $this->response->setJsonContent ( [ 
					'status' => true,
					'data' => $userval
			] );
		}
	}
	
	
	/**
	 * Change password
	 */
	function changepassword(){
		
		$input_data = $this->request->getJsonRawBody ();
		$headers = $this->request->getHeaders ();
		if (empty ( $headers ['Token'] )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Please give the token' 
			] );
		}
		$authentication = new AuthenticationController ();
		$validatetoken = $authentication->validatetoken ( $headers ['Token'] );
		$userdetail = $authentication->getuidtoken ( $headers ['Token'] );
		if (empty($validatetoken)) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid User' 
			] );
		}
		if(empty($input_data)){
			return $this->response->setJsonContent([
					'status' => false,
					'message' => "Please fill the form"
			] );
		}
		$validation = new Validation ();
		$validation->add ( 'oldpassword', new PresenceOf ( [
				'message' => 'Old password is required'
		] ) );
		$validation->add ( 'password', new PresenceOf ( [
				'message' => 'Password is required'
		] ) );
		$validation->add ( 'confirmpassword', new PresenceOf ( [
				'message' => 'Confirm Password is required'
		] ) );
		$messages = $validation->validate ( $input_data );
		if (count ( $messages )) {
				
			foreach ( $messages as $message ) {
				$result [] = $message->getMessage ();
			}
			return $this->response->setJsonContent([
					'status' => false,
					'message' => $result
			] );
		}
		if ($input_data->password != $input_data->confirmpassword) {
			return $this->response->setJsonContent ( [
					'status' => false,
					'message' => "Password doesnot match"
			] );
		}
		$ldapconn = $this->connection ();
		$ldapbind = ldap_bind($ldapconn, self::ldaprdn, self::ldappass);
		if ($ldapbind) {
			$search = "uid=" . $userdetail['username'];
			$user = ldap_search ( $ldapconn, self::ldaprdn, $search );
			$userinfo = ldap_get_entries ( $ldapconn, $user );
			if (! empty ( $userinfo ['count'] )) {
				$ldapBindUser = ldap_bind ( $ldapconn, $userinfo [0] ['dn'], md5 ( $input_data->oldpassword ) );
				if (empty($ldapBindUser)) {
					return $this->response->setJsonContent ( [ 
							'status' => false,
							'message' => 'Invalid old password' 
					] );
				}
				$userdata ['userpassword'] = md5 ( $input_data->password );
				$result = ldap_mod_replace ( $ldapconn, 'cn=' . $userdetail['username']. ',ou=users,' . self::ldaprdn, $userdata );
				
				if ($result) {
					$user_info = Users::findFirstByemail($userdetail['username']);
						$mail = new PHPMailer;

						//$mail->SMTPDebug = 3;                               // Enable verbose debug output

						$mail->isSMTP();                                      // Set mailer to use SMTP
						$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
						$mail->SMTPAuth = true;                               // Enable SMTP authentication
						$mail->Username = 'baskar@haselfre.com';                 // SMTP username
						$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
						$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
						$mail->Port = 587;                                    // TCP port to connect to

						$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
						$mail->addAddress($user_info->email, '');     // Add a recipient
																				// Name is optional
						$mail->addReplyTo('contact@haselfre.com', 'Information');

						//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
						//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
						$mail->isHTML(true);                                  // Set email format to HTML

						$mail->Subject = 'RESET YOUR NIDARA-CHILDREN PASSWORD…';
						
						$mail->Body    = '
										<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

           body,td{
            font-family:verdana,geneva;
            font-size:12px;
           }
           body{
            background:#fff;
            padding:20px;
           }
           .top-img{
            width:100%;
            text-align:center;
            padding-bottom:0;
            font-size:10px;
           }
           .sub-mail-cont{
            width:100%;
           }
           .sub-mail-vr{
            width:580px;
            margin:auto;
            float:none;
           }
           .main-page-mail{
            width:100%;
            float:left;
            padding:20px;
            border:1px solid #999;
           }
           .sub-mail-but{
            width:100%;
            text-align:center;
            padding-top:30px;
            float:left;
           }
           a.sub-but{
            text-decoration:none;
            color:#333;
            padding:10px 50px;
            border:1px solid;
           }
           .sub-but-cont{
            width:100%;
            padding-top:20px;
            float:left;
           }
           .footer{
            width:100%;
            text-align:center;
            font-size:10px;
            padding-top:20px;
            float:left;
           }
           .footer ul{
            list-style:none;
            float:left;
            margin:15px 10px;
            width:100%;
            padding:0;
           }
           .footer ul li{
            display:inline-flex;
            padding-left:5px;
           }
           p{
            line-height:18px;
           }
           .small{
            font-size:11px;
           }
           .main-title{
            text-align:center;
            color:#aed7d3;
            float:left;
            width:100%;
           }
           .main-title h3{
            font-weight:500;
           }
           .first-name{
            text-transform:capitalize;
           }
           .product-img{
            width:20%;
            float:left;
            padding-right:20px;
           }
           .product-img img{
            width:100%;
           }
           .product-cont{
            width:75%;
            float:left;
           }
           .product-details{
            width:100%;
            float:left;
           }
         
span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

          
          <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
            <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
           <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
             <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
           </div>
           <div class="main-title" style="text-align: center; color: #aed7d3; float: left; width: 100%;">
             <h3 style="font-weight: 500;">YOUR PASSWORD HAS BEEN RESET&hellip;</h3>
           </div>
           <div class="sub-mail-cont" style="width: 100%;">
             <span>Hi <span class="first-name" style="text-transform: capitalize;">'. $user_info->first_name .' '. $user_info->last_name .'</span>, </span>
             <br /><p style="line-height: 18px;">The password for your Nidara-Children account ('. $user_info->email .') has been successfully reset.
             If you did not make this change or you believe an unauthorized person has accessed your account, go to www.nidarachildren.com to reset your password without delay.
           </p>
            </div>
            
            <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
           <p style="line-height: 18px;">Best regards,</p>
           <p style="line-height: 18px;">
            </p>
            <p style="line-height: 18px;">Nidara Children</p>
          </div>
          <div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
            <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
             <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
           </li>
           </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
           <br /><span>You are receiving this email because you opted in at our website.
            </span>
            
            <br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
          </div>
           </div>
         </div>
         
</td></tr></table>
</body>
</html>

						';
						$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

						if(!$mail->send()) {
							return $this->response->setJsonContent ( [ 
									'status' => false,
									'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
							] );
							
						} else {
						
							return $this->response->setJsonContent ( [ 
									'status' => true,
									'message' => 'Message has been sent' 
							] );
						}
					
					
					return $this->response->setJsonContent ( [ 
							'status' => true,
							'message' => 'Password changed successfully' 
					] );
				} else {
					return $this->response->setJsonContent ( [ 
							'status' => false,
							'message' => 'Couldnot change the password' 
					] );
				}
			} else {
				return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Invalid username or password' 
				] );
			}
		} else {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'LDAP bind failed' 
			] );
		}
	}
	/**
	 * Check the login credential and create token from the JWT
	 */
	public function logincheck() {
		$ldapconn = $this->connection ();
		$input_data = $this->request->getJsonRawBody ();
		if(empty($input_data)){
			return $this->response->setJsonContent([
					'status' => false,
					'message' => "Please give the details and then login"
			] );
		}
		$validation = new Validation ();
		$validation->add ( 'username', new PresenceOf ( [ 
				'message' => 'Username is required' 
		] ) );
		$validation->add ( 'password', new PresenceOf ( [ 
				'message' => 'Password is required' 
		] ) );
		$messages = $validation->validate ( $input_data );
		if (count ( $messages )) {
			
			foreach ( $messages as $message ) {
				$result [] = $message->getMessage ();
			}
			return $this->response->setJsonContent([ 
					'status' => false,
					'message' => $result
			] );
		}
		$password = md5 ( $input_data->password );
		$search = "uid=" . $input_data->username;
		$user = ldap_search ( $ldapconn, self::ldaprdn, $search );
		$userinfo = ldap_get_entries ( $ldapconn, $user );
		if (! empty ( $userinfo ['count'] )) {
			$ldapBindUser = ldap_bind ( $ldapconn, $userinfo [0] ['dn'], md5 ( $input_data->password ) );
			if ($ldapBindUser) {
				$authentication = new AuthenticationController ();
				$token = ( string ) $authentication->tokengenerate ( $userinfo [0] ['uidnumber'] [0], $input_data->username );
				$this->tokenadd ( $token, $userinfo [0] ['uidnumber'] [0] );
				$user = Users::findFirstByid ( $userinfo [0] ['uidnumber'] [0]);
				/*return $this->response->setJsonContent ( [
						'status' => true,
						'token' => $token,
						'is_active'=> $user->status,
						'message' => 'Login successful'
				] );*/
				if($user->status === '1' || $user->status === '2' || $user->status === '3'){
					return $this->response->setJsonContent ( [
						'status' => true,
						'token' => $token,
						'is_active'=> $user->status,
						'users_id'=> $user->id,
						'message' => 'Login successful'
					] );
				}
				else if($user->status === '4'){
					return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Your account has been deactivated. Please contact us for further assistance.' 
					] );
				}
				else{
					return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Invalid username or password and status' 
					] );
				}
			} else {
				return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Invalid username or password' 
				] );
			}
		} else {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid username and password' 
			] );
		}
	}
	
	
	/**
	 * Add token info	
	 * @param string $token        	
	 * @param integer $users_id        	
	 */
	public function tokenadd($token, $users_id) {
		$token_data = TokenUsers::findFirstByusers_id ( $users_id );
		if (empty ( $token_data )) {
			$token_data = new TokenUsers ();
			$token_data->id = $this->usersid->getNewId ( "token" );
		}
		$token_data->token = $token;
		$token_data->users_id = $users_id;
		$token_data->last_modified_at = date("Y-m-d H:i:s");
		$token_data->save ();
	}
	/**
	 * Check token
	 * @param token
	 * @return array
	 */
	function tokencheck() {
		$input_data = $this->request->getJsonRawBody ();
		$headers = $this->request->getHeaders ();
		if (empty ( $headers ['Token'] )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Please give the token' 
			] );
		}
		$authentication = new AuthenticationController ();
		$validatetoken = $authentication->validatetoken ( $headers ['Token'] );
		$token_users = TokenUsers::findFirstBytoken ( $headers ['Token'] );
		if (empty ( $validatetoken )) {
			$useractive = $this->useractive ( $headers ['Token'] );
			if (empty ( $useractive['success'] )) {
				if (! empty ( $token_users )) {
				  $token_users->delete ();
				}
				return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Invalid user' 
				] );
			} else {
				return $this->response->setJsonContent ( [ 
						'status' => true,
						'message' => 'Valid User',
						"refresh_token" => $useractive['refresh_token'] 
				] );
			}
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid user' 
			] );
		}
		if (! empty ( $token_users )) {
			$token_users->last_modified_at = date ( "Y-m-d H:i:s" );
			$token_users->save ();
		}
		if ($validatetoken && ! empty ( $token_users )) {
			return $this->response->setJsonContent ( [ 
					'status' => true,
					'message' => 'Valid User' 
			] );
		} else {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid User' 
			] );
		}
	}
	public function useractive($token){
		date_default_timezone_set('Asia/Kolkata');
		$token_users = TokenUsers::findFirstBytoken ( $token );
		$seconds  = strtotime(date('Y-m-d H:i:s')) - strtotime($token_users->last_modified_at);
		$currentTime = new \DateTime ( 'now' );
		$last_login_time=new \DateTime ( $token_users->last_modified_at );
		$interval = $currentTime->diff ( $last_login_time );
		$hours = $interval->format ( '%h' );
		$minutes = $interval->format ( '%i' );
		if (empty($hours) && $mins < 60) {
			$authentication = new AuthenticationController ();
			$userinfo=$authentication->getuidtoken($token);
			$tokennew = ( string ) $authentication->tokengenerate ( $userinfo ['uid'], $userinfo ['username'] );
			$token_users->token = $tokennew;
			$token_users->last_modified_at = date ( "Y-m-d H:i:s" );
			$token_users->save ();
			return array (
					"success" => true,
					"refresh_token" => $tokennew 
			);
			
		} else {
			return array (
					"success" => false
			);
		}
	}
	public function sesConfiguration(){
		$profile = 'default';
		$path = APP_PATH . '/config/credentials.ini';
		
		$provider = CredentialProvider::ini ( $profile, $path );
		$provider = CredentialProvider::memoize ( $provider );
		// Instantiate an Amazon S3 client.
		$ses = SesClient::factory(array(
				'version' => 'latest',
				'region'  => 'us-east-1',
				'credentials' => $provider
		));
		return $ses;
	}
	/**
	 * Get profile info by token
	 */
	public function getuserinfobytoken() {
		$headers = $this->request->getHeaders ();
		if (empty ( $headers ['Token'] )) {
			return $this->response->setJsonContent ( [
					'status' => false,
					'message' => 'Please give the token'
			] );
		}
		$authentication = new AuthenticationController ();
		$tokencheck=$authentication->validatetoken( $headers ['Token'] );
		$user = $authentication->getuidtoken ( $headers ['Token'] );
		$userdata = Users::findFirst ( $user ['uid'] )->toArray();
		$token_users = TokenUsers::findFirstBytoken($headers ['Token']);
		$userAddressarray = array();
		if ($userdata && ! empty ( $token_users )) {
			$getvalue = $this->modelsManager->createBuilder ()->columns ( array (
				'Users.id as id',
				'Users.parent_type as parent_type',
				'Users.first_name as first_name',
				'Users.last_name as last_name',
				'Users.email as email',
				'Users.mobile as mobile',
				'Users.occupation as occupation',
				'Users.company_name as company_name',
				'Users.created_by as created_by',
				'Users.modified_at as modified_at',
				'UsersAddress.address_1 as address_1',
				'UsersAddress.address_2 as address_2',
				'UsersAddress.city as city',
				'UsersAddress.state as state',
				'UsersAddress.country as country',
				'UsersAddress.post_code as post_code',
			))->from("Users")
			->leftjoin('UsersAddress','UsersAddress.user_id = Users.id')
			->inwhere('Users.id',array($userdata['id']))
			->getQuery()->execute ();
			return $this->response->setJsonContent ( [
					'status' => true,
					'user_info' => $userdata,
					'useraddress' => $getvalue,
			] );
		} else {
			return $this->response->setJsonContent ( [
					'status' => false,
					'message' => 'Invalid User'
			] );
		}
	}

	/**
	 * Check the password is to get into the parent dashboard
	 */
	public function parentvalidate() {
		$ldapconn = $this->connection ();
		$input_data = $this->request->getJsonRawBody ();
		$headers = $this->request->getHeaders ();
		if (empty ( $headers ['Token'] )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Please give the token' 
			] );
		}
		if (empty ( $input_data->password )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Please give the password' 
			] );
		}
		$authentication = new AuthenticationController ();
		$tokencheck=$authentication->validatetoken( $headers ['Token'] );
		if(empty($tokencheck)){
		return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Invalid user' 
				] );
		}
		$user = $authentication->getuidtoken ( $headers ['Token'] );
		$search = "uid=" . $user['username'];
		$usersearch = ldap_search ( $ldapconn, self::ldaprdn, $search );
		$userinfo = ldap_get_entries ( $ldapconn, $usersearch );
		if (! empty ( $userinfo ['count'] )) {
			$ldapBindUser = ldap_bind ( $ldapconn, $userinfo [0] ['dn'], md5 ( $input_data->password ) );
			if ($ldapBindUser) {
				return $this->response->setJsonContent ( [ 
						'status' => true,
						'message' => 'Valid User',
						'username'=> $user ['username'] 
				] );
			} else {
				return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Invalid password' 
				] );
			}
		} else {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid password' 
			] );
		}
	}

     	/**
	 * Reset password
	 */
	public function resetpassword() {
		$input_data = $this->request->getJsonRawBody ();
		$headers = $this->request->getHeaders ();
		if (empty ( $headers ['Token'] )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => "Please give the token" 
			] );
		}
		$authentication = new AuthenticationController ();
		$validatetoken = $authentication->validatetoken ( $headers ['Token'] );
		$userdetail = $authentication->getuidtoken ( $headers ['Token'] );
		if (empty ( $validatetoken )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid User' 
			] );
		}
		if (empty ( $input_data )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => "Please fill the form" 
			] );
		}
		$validation = new Validation ();
		$validation->add ( 'password', new PresenceOf ( [ 
				'message' => 'Password is required' 
		] ) );
		$validation->add ( 'confirmpassword', new PresenceOf ( [ 
				'message' => 'Confirm Password is required' 
		] ) );
		$messages = $validation->validate ( $input_data );
		if (count ( $messages )) {
			
			foreach ( $messages as $message ) {
				$result [] = $message->getMessage ();
			}
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'data' => $result 
			] );
		}
		if ($input_data->password != $input_data->confirmpassword) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => "Password doesnot match" 
			] );
		}
		$ldapconn = $this->connection ();
		$ldapbind = ldap_bind ( $ldapconn, self::ldaprdn, self::ldappass );
		if ($ldapbind) {
			$search = "uid=" . $userdetail['username'];
			$user = ldap_search ( $ldapconn, self::ldaprdn, $search );
			$userinfo = ldap_get_entries ( $ldapconn, $user );
			if (empty ( $userinfo ['count'] )) {
				return $this->response->setJsonContent ([ 
						'status' => false,
						'message' => 'Invalid Username' 
				]);
			}
			$userdata ['userpassword'] = md5 ( $input_data->password );
			$result = ldap_mod_replace ( $ldapconn, 'cn=' . $userdetail['username'] . ',ou=users,' . self::ldaprdn, $userdata );
			if ($result) {
				$tokenexpire = $authentication->validatetoken ( $headers ['Token'],"logout" );
				
				$user_info = Users::findFirstByemail($userdetail['username']);
						$mail = new PHPMailer;

						//$mail->SMTPDebug = 3;                               // Enable verbose debug output

						$mail->isSMTP();                                      // Set mailer to use SMTP
						$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
						$mail->SMTPAuth = true;                               // Enable SMTP authentication
						$mail->Username = 'baskar@haselfre.com';                 // SMTP username
						$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
						$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
						$mail->Port = 587;                                    // TCP port to connect to

						$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
						$mail->addAddress($user_info->email, '');     // Add a recipient
																				// Name is optional
						$mail->addReplyTo('contact@haselfre.com', 'Information');

						//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
						//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
						$mail->isHTML(true);                                  // Set email format to HTML

						$mail->Subject = 'RESET YOUR NIDARA-CHILDREN PASSWORD…';
						
						$mail->Body    = '
										<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

           body,td{
            font-family:verdana,geneva;
            font-size:12px;
           }
           body{
            background:#fff;
            padding:20px;
           }
           .top-img{
            width:100%;
            text-align:center;
            padding-bottom:0;
            font-size:10px;
           }
           .sub-mail-cont{
            width:100%;
           }
           .sub-mail-vr{
            width:580px;
            margin:auto;
            float:none;
           }
           .main-page-mail{
            width:100%;
            float:left;
            padding:20px;
            border:1px solid #999;
           }
           .sub-mail-but{
            width:100%;
            text-align:center;
            padding-top:30px;
            float:left;
           }
           a.sub-but{
            text-decoration:none;
            color:#333;
            padding:10px 50px;
            border:1px solid;
           }
           .sub-but-cont{
            width:100%;
            padding-top:20px;
            float:left;
           }
           .footer{
            width:100%;
            text-align:center;
            font-size:10px;
            padding-top:20px;
            float:left;
           }
           .footer ul{
            list-style:none;
            float:left;
            margin:15px 10px;
            width:100%;
            padding:0;
           }
           .footer ul li{
            display:inline-flex;
            padding-left:5px;
           }
           p{
            line-height:18px;
           }
           .small{
            font-size:11px;
           }
           .main-title{
            text-align:center;
            color:#aed7d3;
            float:left;
            width:100%;
           }
           .main-title h3{
            font-weight:500;
           }
           .first-name{
            text-transform:capitalize;
           }
           .product-img{
            width:20%;
            float:left;
            padding-right:20px;
           }
           .product-img img{
            width:100%;
           }
           .product-cont{
            width:75%;
            float:left;
           }
           .product-details{
            width:100%;
            float:left;
           }
         
span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body bgcolor="#fff" style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="" bgcolor="#fff"><tr><td>

          
          <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
            <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
           <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
             <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
           </div>
           <div class="main-title" style="text-align: center; color: #aed7d3; float: left; width: 100%;">
             <h3 style="font-weight: 500;">YOUR PASSWORD HAS BEEN RESET&hellip;</h3>
           </div>
           <div class="sub-mail-cont" style="width: 100%;">
             <span>Hi <span class="first-name" style="text-transform: capitalize;">'. $user_info->first_name .' '. $user_info->last_name .'</span>, </span>
             <br /><p style="line-height: 18px;">The password for your Nidara-Children account ('. $user_info->email .') has been successfully reset.
             If you did not make this change or you believe an unauthorized person has accessed your account, go to www.nidarachildren.com to reset your password without delay.
           </p>
            </div>
            
            <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
           <p style="line-height: 18px;">Best regards,</p>
           <p style="line-height: 18px;">
            </p>
            <p style="line-height: 18px;">Nidara Children</p>
          </div>
          <div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
            <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
             <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
           </li>
           <li style="display: inline-flex; padding-left: 5px;">
             <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
           </li>
           </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
           <br /><span>You are receiving this email because you opted in at our website.
            </span>
            
            <br /><span><a href="https://faq.nidarachildren.com/wp-content/themes/nidara/Newsletter-contact/Nidara_Newslatter.vcf">Add us to your address book</a> | <a href="https://nidarachildren.us17.list-manage.com/unsubscribe?u=e2c0982dd8b7d1a16f74d886d&id=fae67dd82a&e=*%7CUNIQID%7C*">Unsubscribe from this list</a></span>
          </div>
           </div>
         </div>
         
</td></tr></table>
</body>
</html>

						';
						$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

						if(!$mail->send()) {
							return $this->response->setJsonContent ( [ 
									'status' => false,
									'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
							] );
							
						} else {
						
							return $this->response->setJsonContent ( [ 
									'status' => true,
									'message' => 'Your password has been reset succesfully.' 
							] );
						}
					
				return $this->response->setJsonContent ( [ 
						'status' => true,
						'message' => 'Password changed successfully' 
				] );
			} else {
				return $this->response->setJsonContent ( [ 
						'status' => false,
						'message' => 'Couldnot change the password'
				] );
			}
		} else {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'LDAP bind failed' 
			] );
		}
	}

	/**
	 * Logout
	 */
	public function logout() {
		$headers = $this->request->getHeaders ();
		if (empty ( $headers ['Token'] )) {
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Please give the token' 
			] );
		}
		$token = TokenUsers::findFirstBytoken($headers ['Token']);	
		if(empty($token)){
			return $this->response->setJsonContent ( [ 
					'status' => false,
					'message' => 'Invalid token' 
			] );
		}
		$authentication = new AuthenticationController ();
		$expiretoken = $authentication->validatetoken ( $headers ['Token'],'logout' );	
		if ($token->delete ()) {
			return $this->response->setJsonContent ([ 
					'status' => true,
					'message' => 'User logout successfully' 
			]);
		} else {
			return $this->response->setJsonContent ([ 
					'status' => false,
					'message' => 'Cannot logout' 
			]);
		}
	}

	public function outofindiamail(){
		$input_data = $this->request->getJsonRawBody ();
		if($input_data->outofindia == 1){
			$title = 'Out of india notification';
		} else {
			$title = 'Customer Enquiry';
		}
		$mail = new PHPMailer;

		//$mail->SMTPDebug = 3;                               // Enable verbose debug output

		$mail->isSMTP();                                      // Set mailer to use SMTP
		$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
		$mail->SMTPAuth = true;                               // Enable SMTP authentication
		$mail->Username = 'baskar@haselfre.com';                 // SMTP username
		$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
		$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
		$mail->Port = 587;                                    // TCP port to connect to

		
		$mail->setFrom($input_data->email, '');     // Add a recipient
		$mail->addAddress('contact@haselfre.com', 'Nidara-Children');
																// Name is optional
		$mail->addReplyTo('contact@haselfre.com', 'Information');

		//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
		//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
		$mail->isHTML(true);                                  // Set email format to HTML

		// $mail->Subject = 'NIDARA-CHILDREN NOTIFY ME';
		$mail->Subject = 'Nidara-Children Notify Me';
		$mail->Body    = '
						<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
							<html>
							  <head>
								<meta http-equiv="content-type" content="text/html; charset=utf-8">
								
							  <style type="text/css">
									body,td{
										font-family:verdana,geneva;
										font-size:12px;
									}
									body{
										background:#fff;
										padding:20px;
									}
									.top-img{
										width:100%;
										text-align:center;
										padding-bottom:0;
										font-size:10px;
									}
									.sub-mail-cont{
										width:100%;
									}
									.sub-mail-vr{
										width:580px;
										margin:auto;
										float:none;
									}
									.main-page-mail{
										width:100%;
										float:left;
										padding:20px;
										border:1px solid #999;
									}
									.sub-mail-but{
										width:100%;
										text-align:center;
										padding-top:30px;
										float:left;
									}
									a.sub-but{
										text-decoration:none;
										color:#333;
										padding:10px 50px;
										border:1px solid;
									}
									.sub-but-cont{
										width:100%;
										padding-top:20px;
										float:left;
									}
									.footer{
										width:100%;
										text-align:center;
										font-size:10px;
										padding-top:20px;
										float:left;
									}
									.footer ul{
										list-style:none;
										float:left;
										margin:15px 10px;
										width:100%;
										padding:0;
									}
									.footer ul li{
										display:inline-flex;
										padding-left:5px;
									}
									p{
										line-height:18px;
									}
									.small{
										font-size:11px;
									}
									.main-title{
										text-align:center;
										color:#aed7d3;
										float:left;
										width:100%;
									}
									.main-title h3{
										font-weight:500;
									}
									.first-name{
										text-transform:capitalize;
									}
									.product-img{
										width:20%;
										float:left;
										padding-right:20px;
									}
									.product-img img{
										width:100%;
									}
									.product-cont{
										width:75%;Out of india notification
										float:left;
									}
									.product-details{
										width:100%;
										float:left;
									}
							</style></head>
							  <body bgcolor="#fff">
								<p style="font-weight: bold;">'. $title .'</p>
								<p>Email: ' . $input_data->email . '</p>
							
							</body>
							</html>
		';
		$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

		if(!$mail->send()) {
			return $this->response->setJsonContent ([ 
					'status' => false,
					'message' => 'Message could not be sent.' ,
					'data' => $mail->ErrorInfo
			]);
			
		} 
		else {
				return $this->response->setJsonContent ([ 
					'status' => true,
					'message' => 'Message has been sent' 
			]);
		}	
	} 
	
	
	public function emailverify(){
		$input_data = $this->request->getJsonRawBody ();
		$collection = EmailVerify::findFirstByencrypt_code($input_data->encrypt_code);
		if(!empty($collection)){
			$collection->status = 1;
			if($collection->save()){
				$user_info = Users::findFirstByemail($collection->email_id);
				if($user_info->status === '3'){
					$user_info->status = 1;
					$user_info->save();
					$emailcontent = '<div class="sub-mail-cont">
												<span>Hi <span class="first-name">'. $user_info->first_name .' '. $user_info->last_name .'</span>, </span>
												<p>Your email address has been verified.  You can start using Nidara-Children now. </p>
											</div>
											<br>
											 <div class="sub-mail-but">
											 <p style="text-align:center;">
											   <a class="sub-but" style="text-decoration: none; color: #333; padding: 10px 50px; border: 1px solid;" href="'. $this->config->weburl .'/signin"><b>SIGN IN</b>
											  </a>
											  </p>
											 </div>';
				}
				else if($user_info->status === '2'){
					$emailcontent = '<div class="sub-mail-cont">
												<span>Hi <span class="first-name">'. $user_info->first_name .' '. $user_info->last_name .'</span>, </span>
												<p>Your email address has been verified.  You can start using Nidara-Children Free Trial now. </p>
											</div>
											<br>
											 <div class="sub-mail-but">
											 <p style="text-align:center;">
											   <a style="text-decoration: none; color: #333; padding: 10px 50px; border: 1px solid;" class="sub-but" href="'. $this->config->weburl .'/signin"><b>SIGN IN</b>
											  </a>
											  </p>
											 </div>';
				}
				$mail = new PHPMailer;

					//$mail->SMTPDebug = 3;                               // Enable verbose debug output

				$mail->isSMTP();                                      // Set mailer to use SMTP
				$mail->Host = 'smtp-relay.sendinblue.com';  // Specify main and backup SMTP servers
				$mail->SMTPAuth = true;                               // Enable SMTP authentication
				$mail->Username = 'baskar@haselfre.com';                 // SMTP username
				$mail->Password = 'k6zcNyXJw27MCT0j';                           // SMTP password
				$mail->SMTPSecure = 'tls';                            // Enable TLS encryption, `ssl` also accepted
				$mail->Port = 587;                                    // TCP port to connect to

				$mail->setFrom('contact@haselfre.com', 'Nidara-Children');
				$mail->addAddress($user_info->email, '');     // Add a recipient
																			// Name is optional
				$mail->addReplyTo('contact@haselfre.com', 'Information');

					//$mail->addAttachment('/var/tmp/file.tar.gz');         // Add attachments
					//$mail->addAttachment('/tmp/image.jpg', 'new.jpg');    // Optional name
				                                  // Set email format to HTML

				$mail->Subject = 'YOUR EMAIL ADDRESS HAS BEEN VERIFIED.';
				$mail->Body    = '<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Email</title>
<style type="text/css">
.ReadMsgBody {width: 100%;}
.ExternalClass {width: 100%;}

body {}

         body,td{
         font-family:verdana,geneva;
         font-size:12px;
         }
         body{
         background:#fff;
         padding:20px;
         }
         .top-img{
         width:100%;
         text-align:center;
         padding-bottom:0;
         font-size:10px;
         }
         .sub-mail-cont{
         width:100%;
         }
         .sub-mail-vr{
         width:580px;
         margin:auto;
         float:none;
         }
         .main-page-mail{
         width:100%;
         float:left;
         padding:20px;
         border:1px solid #999;
         }
         .sub-mail-but{
         width:100%;
         text-align:center;
         padding-top:30px;
         float:left;
         }
         a.sub-but{
         text-decoration:none;
         color:#333;
         padding:10px 50px;
         border:1px solid;
         }
         .sub-but-cont{
         width:100%;
         padding-top:20px;
         float:left;
         }
         .footer{
         width:100%;
         text-align:center;
         font-size:10px;
         padding-top:20px;
         float:left;
         }
         .footer ul{
         list-style:none;
         float:left;
         margin:15px 10px;
         width:100%;
         padding:0;
         }
         .footer ul li{
         display:inline-flex;
         padding-left:5px;
         }
         p{
         line-height:18px;
         }
         .small{
         font-size:11px;
         }
         .main-title{
         text-align:center;
         color:#aed7d3;
         float:left;
         width:100%;
         }
         .main-title h3{
         font-weight:500;
         }
         .first-name{
         text-transform:capitalize;
         }
         .product-img{
         width:20%;
         float:left;
         padding-right:20px;
         }
         .product-img img{
         width:100%;
         }
         .product-cont{
         width:75%;
         float:left;
         }
         .product-details{
         width:100%;
         float:left;
         }
      
span.yshortcuts { color:#000; background-color:none; border:none;}
span.yshortcuts:hover,
span.yshortcuts:active,
span.yshortcuts:focus {color:#000; background-color:none; border:none;}
</style>
</head>
<body style="font-family: verdana,geneva; font-size: 12px; background: #fff; padding: 20px;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style=""><tr><td>

      <div class="sub-mail-vr" style="width: 580px; margin: auto; float: none;">
         <div class="main-page-mail" style="width: 100%; float: left; padding: 20px; border: 1px solid #999;">
            <div class="top-img" style="width: 100%; text-align: center; padding-bottom: 0; font-size: 10px;">
               <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/07/170x150_logo.jpg" alt="170x150_logo.jpg" /><p style="line-height: 18px;">THE BEST START IN LIFE</p>
            </div>
            '. $emailcontent .'
            <div class="sub-but-cont" style="width: 100%; padding-top: 20px; float: left;">
               <p style="line-height: 18px;">Best regards,</p>
               <p style="line-height: 18px;">
               </p>
               <p style="line-height: 18px;">Nidara Children</p>
            </div>
            <div class="footer" style="width: 100%; text-align: center; font-size: 10px; padding-top: 20px; float: left;">
               <ul style="list-style: none; float: left; margin: 15px 10px; width: 100%; padding: 0;">
<li style="display: inline-flex; padding-left: 5px;">
                     <a class="fb" href="https://www.facebook.com/NidaraChildren/" target="_blank"><img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/facebook-mint.png" alt="facebook-mint.png" /></a>
                  </li>
                  <li style="display: inline-flex; padding-left: 5px;">
                     <a class="twt" href="https://twitter.com/nidarachildren" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/twitter-mint.png" alt="twitter-mint.png" /></a>
                  </li>
                  <li style="display: inline-flex; padding-left: 5px;">
                     <a class="ins" href="https://www.instagram.com/nidarachildren/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/instagram-mint.png" alt="instagram-mint.png" /></a>
                  </li>
                  <li style="display: inline-flex; padding-left: 5px;">
                     <a class="email" href="'. $this->config->weburl .'/contact-us/" target="_blank"> <img src="https://faq.nidarachildren.com/wp-content/uploads/2018/01/mail-mint.png" alt="mail-mint.png" /></a>
                  </li>
               </ul>
<span>Copyright &copy; Nidara-Children. All rights reserved.</span>
               <br /><span>You are receiving this email because you opted in at our website.
               </span>
               <br /><span><a href="">Add us to your address book</a> | <a href="">Unsubscribe from this list</a></span>
            </div>
         </div>
      </div>
   
</td></tr></table>
</body>
</html>
';
					$mail->IsHTML(true);
					$mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

					if(!$mail->send()) {
						return $this->response->setJsonContent ( [ 
								'status' => false,
								'message' => 'Message could not be sent. Mailer Error: ' . $mail->ErrorInfo 
						] );
						
					} else {
						return $this->response->setJsonContent ( [ 
								'status' => true,
								'data' => $user_info
						] );
						
					}
			}
		}
		else{
			return $this->response->setJsonContent ( [ 
				'status' => false,
				'message' => 'The token has been expired' 
			] );
		}
		
	}
	public function updatetoken(){
		$input_data = $this->request->getJsonRawBody ();
		return $this->response->setJsonContent ( [ 
			'status' => true,
			'message' => $input_data
		] );
		$coloection = TokenUsers::findFirstByusers_id($input_data -> users_id);
		if(!$coloection){
			$coloection = new TokenUsers();
			$coloection -> id = $this->usersid->getNewId("users-token");
		}
		$coloection -> token = $input_data -> token;
		if($coloection -> save()){
			return $this->response->setJsonContent ( [ 
				'status' => true,
				'message' => 'data saved'
			] );
		} else {
			return $this->response->setJsonContent ( [ 
				'status' => false,
				'message' => 'data not saved'
			] );
		}
	}



	public function saveExcel(){
        $input_data = $this->request->getJsonRawBody ();
        $tmpfname = $input_data -> file_name;
	$excelarray = array();
$fileHandle = fopen($tmpfname, "r");
//Loop through the CSV rows.
$i = 0;
$ldapconn = $this->connection ();
while (($row = fgetcsv($fileHandle, 0, ",")) !== FALSE) {
    //Print out my column data.
   // echo 'Name: ' . $row[0] . '<br>';
   // echo 'Country: ' . $row[1] . '<br>';
  //  echo 'Age: ' . $row[2] . '<br>';
  //  echo '<br>';
  if($i >= 5){
	// $data['1'] = $row[0];
	// $data['2'] = $row[1];
	// $data['3'] = $row[2];
	// $data['4'] = $row[3];
	// $data['5'] = $row[4];
	// $data['6'] = $row[5];
	// $data['7'] = $row[6];
	// $data['8'] = $row[7];
	// $data['9'] = $row[8];
	// $data['10'] = $row[9];
	// $data['11'] = $row[10];
    // $data['12'] = $row[11];
    // $excelarray[] = $data;
    $user = Users::findFirstByemail($row[4]);

                if(!$user){
                    $user = new Users ();
                    $user->id = $this->usersid->getNewId("users");
                    $user->parent_type = 'father';
                    $user->first_name = ($row[2]);
                    $user->last_name = ($row[3]);
                    $user->user_type = 'parent';
                    $user->email = ($row[4]);
                    $user->photo = 'https://s3.ap-south-1.amazonaws.com/illustration.nidarachildren.com/assets/kids/photo/icon.png';
                    $user->mobile = ($row[5]);
		   $user->created_at = date ( 'Y-m-d H:i:s' );
				$user->created_by = $input_data->school_id;
				$user->status = 2;
				$user->act_status = 2;
				$user->modified_at = date ( 'Y-m-d H:i:s' );
				if(!$user->save()){
					return $this->response->setJsonContent([
						'status' => false,
						'message' => "Please upload the excel format as per NC standard. "
					] );
				}else {
                        $code = $this -> generate_random_letters();
                        $email = $row[4];
                        $password = $code;
                        $userpassword = new UserTemPassword();
                        $userpassword -> user_id = $user-> id;
                        $userpassword -> password = $code;
                        if(!$userpassword -> save()){
                            return $this->response->setJsonContent ( [ 
                                'status' => false,
                                'message' => "Password not save"
                            ] );

                        }
                        $ldapbind = ldap_bind($ldapconn, self::ldaprdn, self::ldappass);
                        if ($ldapbind) {
                            /**
                             * This object using valitaion
                             */
                            $ldaprecord ['sn'] [0] = $row[2];
                            $ldaprecord ['objectclass'] [2] = "top";
                            $ldaprecord ['objectclass'] [1] = "posixAccount";
                            $ldaprecord ['objectclass'] [0] = "inetOrgPerson";
                            $ldaprecord ['uid'] [0] = $email;
                            $ldaprecord ['gidnumber'] [0] = '500';
                            $ldaprecord ['givenname'] [0] = $row[2];
                            $ldaprecord ['uidnumber'] [0] = $user-> id;
                            $ldaprecord ['userpassword'] [0] = md5 ($password);
                            $ldaprecord ['loginshell'] [0] = '/bin/sh';
                            $ldaprecord ['homedirectory'] [0] = "/home/users/$email";
                            $ldaprecord ['street'] [0] = $email;
                            
                            // add data to directory
                            $r = ldap_add ( $ldapconn, 'cn=' . $email . ',ou=users,' . self::ldaprdn, $ldaprecord );
                            
                            if (!$r) {
                                return $this->response->setJsonContent ( [ 
                                    'status' => false,
                                    'message' => 'couldnot save user' 
                                ] );
                            }
                            } else {
                                return $this->response->setJsonContent ( [ 
                                    'status' => false,
                                    'message' => 'LDAP bind failed' 
                                ] );
                        }
				}
                        $kidprofile = new NidaraKidProfile ();
						$kidprofile->id = $this->kididgen->getNewId ( "nidarakidprofile" );
						$kidprofile->first_name = $row[6];
						if (! empty ( $childvalue->middle_name )) {
							$kidprofile->middle_name = $childvalue->middle_name;
						}
						$kidprofile->last_name = $row[7];
						$kidprofile->date_of_birth = date('Y-m-d');
						if(!empty($input_data->age)){
							$kidprofile->age = $childvalue->age;
						}
						$kidprofile->gender = $row[9];
						$kidprofile->height = '0';
						$kidprofile->weight = '0';
						$kidprofile->grade = $row[8];
						$kidprofile->created_at = date ( 'Y-m-d H:i:s' );
						$kidprofile->created_by = $user -> id;
						$kidprofile->modified_at = date ( 'Y-m-d H:i:s' );
						$kidprofile->status = 2;
						$kidprofile->cancel_subscription = 1;
						if (empty ( $childvalue->child_photo )) {
							$gender = $childvalue->gender;
							if ($gender == 'male') {
								$kidprofile->child_photo = 'https://s3.amazonaws.com/nidara-dev/dev-files/no_image_male.png';
							} else {
								$kidprofile->child_photo = 'https://s3.amazonaws.com/nidara-dev/dev-files/no_image_female.png';
							}
						} 
						if (!$kidprofile->save ()) {
							return $this->response->setJsonContent([
								'status' => false,
								'message' => "Please upload the excel format as per NC standard. ",
								'data' => $kidprofile
							] );
						}
						else{
							$kid_guide = new KidGuidedLearningMap ();
							$kid_guide->id = $this->kididgen->getNewId ( "nidarakidlearningmap" );
							$kid_guide->nidara_kid_profile_id = $kidprofile->id;
							$kid_guide->guided_learning_id = $kidprofile->grade;
							$kid_guide->save ();
							$parentsmap = new KidParentsMap ();
							$parentsmap->id = $this->kididgen->getNewId ( "kidparentsmap" );
							$parentsmap->nidara_kid_profile_id = $kidprofile->id;
							$parentsmap->users_id = $user -> id;
							$parentsmap->save();
                        }
                    $parentmap = SchoolParentMap::findFirstByuser_id($user -> id);
                    if(!$parentmap){
                        $parentmap = new SchoolParentMap();
                        $parentmap -> user_id = $user -> id;
                    }
					$parentmap -> school_id = $input_data -> school_id;
					if(!$parentmap -> save()){
						return $this->response->setJsonContent([
							'status' => false,
							'message' => "Please upload the excel format as per NC standard. "
						] );
					}
                }
            }
        $i++;
    }
		// return $this->response->setJsonContent ( [
		// 			"status" => false,
		// 			"message" => $excelarray			
		// 	] );
        return $this->response->setJsonContent ( [
                "status" => true,
                "message" => "File uploaded successfully"
        ] );
    } 
}
